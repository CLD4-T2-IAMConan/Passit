# Loki + Promtail Helm Chart Values
# 로컬 K8s 테스트용 설정
# 
# 주의: loki-stack chart는 deprecated되었을 수 있습니다.
# 최신 버전에서는 loki와 promtail을 별도로 설치하는 것을 권장합니다.
# 하지만 로컬 테스트 목적으로는 이 구성을 사용할 수 있습니다.

# Loki 설정 (로그 수집 및 저장)
loki:
  enabled: true
  persistence:
    enabled: false  # 로컬 테스트용 - emptyDir 사용
    size: 10Gi
  config:
    schema_config:
      configs:
        - from: 2024-01-01
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: index_
            period: 24h
    storage_config:
      boltdb_shipper:
        active_index_directory: /loki/boltdb-shipper-active
        cache_location: /loki/boltdb-shipper-cache
        shared_store: filesystem
      filesystem:
        directory: /loki/chunks
    limits_config:
      retention_period: 168h  # 7일 보관
      ingestion_rate_mb: 10
      ingestion_burst_size_mb: 20
      max_query_length: 721h
      max_query_parallelism: 32
      max_streams_per_user: 10000
      max_line_size: 256KB
    compactor:
      working_directory: /loki/compactor
      shared_store: filesystem
      compaction_interval: 10m
      retention_enabled: true
      retention_delete_delay: 2h
      retention_delete_worker_count: 150
  # 리소스 제한
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi
  # 외부 접근을 위한 NodePort
  service:
    type: NodePort
    nodePort: 30902

# Promtail 설정 (로그 수집 에이전트)
promtail:
  enabled: true
  config:
    clients:
      - url: http://loki:3100/loki/api/v1/push
    snippets:
      # Kubernetes Pod 로그 수집
      scrapeConfigs: |
        - job_name: kubernetes-pods
          kubernetes_sd_configs:
            - role: pod
          pipeline_stages:
            - docker: {}
            - regex:
                expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z)\s+(?P<level>\w+)\s+(?P<message>.*)$'
            - labels:
                level:
                timestamp:
            - timestamp:
                source: timestamp
                format: RFC3339Nano
            - labels:
                namespace:
                pod_name:
                container_name:
                app:
          relabel_configs:
            - source_labels:
                - __meta_kubernetes_pod_label_app
              target_label: app
            - source_labels:
                - __meta_kubernetes_pod_label_component
              target_label: component
            - source_labels:
                - __meta_kubernetes_namespace
              target_label: namespace
            - source_labels:
                - __meta_kubernetes_pod_name
              target_label: pod_name
            - source_labels:
                - __meta_kubernetes_pod_container_name
              target_label: container_name
            - action: replace
              replacement: $1
              separator: /
              source_labels:
                - namespace
                - app
              target_label: job
            - action: replace
              source_labels:
                - __meta_kubernetes_pod_node_name
              target_label: node_name
            - action: replace
              source_labels:
                - __meta_kubernetes_pod_uid
              target_label: pod_uid
            - replacement: /var/log/pods/*$1/*.log
              separator: /
              source_labels:
                - __meta_kubernetes_pod_uid
                - __meta_kubernetes_pod_container_name
              target_label: __path__
            - action: replace
              source_labels:
                - __meta_kubernetes_pod_container_name
              target_label: container
            - action: keep
              source_labels:
                - __meta_kubernetes_pod_controller_name
        # 애플리케이션 로그 레벨별 수집
        - job_name: application-logs
          kubernetes_sd_configs:
            - role: pod
          pipeline_stages:
            - json:
                expressions:
                  timestamp: timestamp
                  level: level
                  logger: logger
                  message: message
                  thread: thread
            - labels:
                level:
                logger:
            - timestamp:
                source: timestamp
                format: RFC3339Nano
          relabel_configs:
            - source_labels:
                - __meta_kubernetes_pod_label_app
              target_label: app
            - source_labels:
                - __meta_kubernetes_namespace
              target_label: namespace
            - action: keep
              regex: (ERROR|WARN|INFO|DEBUG)
              source_labels:
                - __meta_kubernetes_pod_label_app
  # 리소스 제한
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Grafana는 prometheus-operator-values.yaml에서 설정

