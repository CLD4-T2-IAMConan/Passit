# kube-prometheus-stack Helm Chart Values
# 로컬 K8s 테스트용 설정

# Prometheus 설정
prometheus:
  enabled: true
  prometheusSpec:
    retention: 7d
    retentionSize: 10GB
    # ServiceMonitor 자동 발견 설정
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    serviceMonitorSelector:
      matchLabels:
        release: kube-prometheus-stack
    podMonitorSelector:
      matchLabels:
        release: kube-prometheus-stack
    # 로컬 테스트용 - emptyDir 사용 (재시작 시 데이터 삭제)
    storageSpec:
      emptyDir: {}
    # 리소스 제한
    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 1000m
        memory: 4Gi
    # 외부 접근을 위한 NodePort
    service:
      type: NodePort
      nodePort: 30900

# Alertmanager 설정
alertmanager:
  enabled: true
  alertmanagerSpec:
    # 로컬 테스트용 - emptyDir 사용
    storage:
      emptyDir: {}
    # 리소스 제한
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi
    # 외부 접근을 위한 NodePort
    service:
      type: NodePort
      nodePort: 30903
  # Alertmanager 설정 파일
  # 주의: 실제 사용 시 이메일/Slack 설정을 업데이트하세요
  config:
    global:
      resolve_timeout: 5m
      # Slack webhook URL (설정 시 주석 해제 및 값 입력)
      # slack_api_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'
    # 라우팅 규칙
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'default'
      routes:
        - match:
            severity: critical
          receiver: 'critical-alerts'
          continue: true
        - match:
            severity: warning
          receiver: 'warning-alerts'
    # 수신자 설정
    receivers:
      - name: 'default'
        # 이메일 알람 (설정 시 주석 해제 및 값 입력)
        # email_configs:
        #   - to: 'alerts@passit.com'
        #     from: 'monitoring@passit.com'
        #     smarthost: 'smtp.gmail.com:587'
        #     auth_username: 'your-email@gmail.com'
        #     auth_secret:
        #       name: alertmanager-config
        #       key: smtp-password
        #     headers:
        #       Subject: 'Passit Monitoring Alert'
        # 웹훅 알람 (테스트용 - 로컬에서 확인 가능)
        webhook_configs:
          - url: 'http://localhost:9093/api/v1/alerts'
            send_resolved: true
      - name: 'critical-alerts'
        # 이메일 알람
        # email_configs:
        #   - to: 'alerts@passit.com'
        #     from: 'monitoring@passit.com'
        #     smarthost: 'smtp.gmail.com:587'
        #     auth_username: 'your-email@gmail.com'
        #     auth_secret:
        #       name: alertmanager-config
        #       key: smtp-password
        #     headers:
        #       Subject: '[CRITICAL] Passit Monitoring Alert'
        # Slack 알람 (설정 시 주석 해제 및 값 입력)
        # slack_configs:
        #   - api_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'
        #     channel: '#alerts-critical'
        #     title: 'Critical Alert'
        #     text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
        webhook_configs:
          - url: 'http://localhost:9093/api/v1/alerts'
            send_resolved: true
      - name: 'warning-alerts'
        # 이메일 알람
        # email_configs:
        #   - to: 'alerts@passit.com'
        #     from: 'monitoring@passit.com'
        #     smarthost: 'smtp.gmail.com:587'
        #     auth_username: 'your-email@gmail.com'
        #     auth_secret:
        #       name: alertmanager-config
        #       key: smtp-password
        #     headers:
        #       Subject: '[WARNING] Passit Monitoring Alert'
        webhook_configs:
          - url: 'http://localhost:9093/api/v1/alerts'
            send_resolved: true

# Grafana 설정
grafana:
  enabled: true
  adminUser: admin
  adminPassword: admin123!  # 로컬 테스트용 - 프로덕션에서는 변경 필요
  # 외부 접근을 위한 NodePort
  service:
    type: NodePort
    nodePort: 30901
  # 리소스 제한
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
  # Grafana 데이터소스 자동 설정
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://prometheus-operated:9090
          isDefault: true
          editable: true
        - name: Loki
          type: loki
          access: proxy
          url: http://loki:3100
          editable: true
  # 대시보드 자동 로드
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'default'
          orgId: 1
          folder: ''
          type: file
          disableDelete: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/default
  dashboards:
    default:
      kubernetes-cluster:
        gnetId: 7249
        revision: 1
        datasource: Prometheus
      kubernetes-pods:
        gnetId: 6417
        revision: 1
        datasource: Prometheus
      spring-boot:
        gnetId: 11378
        revision: 1
        datasource: Prometheus

# kube-state-metrics (K8s 리소스 메트릭)
kubeStateMetrics:
  enabled: true

# node-exporter (노드 메트릭 - 로컬 K8s에서도 사용 가능)
nodeExporter:
  enabled: true

# prometheus-operator 설정
prometheusOperator:
  enabled: true
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# 기본 알람 규칙 활성화
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: false  # 로컬에서는 etcd 없음
    general: true
    k8s: true
    kubeApiserver: true
    kubeApiserverAvailability: true
    kubeApiserverError: true
    kubeApiserverSlos: true
    kubelet: true
    kubeProxy: true
    kubePrometheusGeneral: true
    kubePrometheusNodeRecording: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    kubeScheduler: true
    kubeStateMetrics: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true
    time: true

