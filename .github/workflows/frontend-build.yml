name: Frontend Deploy to S3

on:
  push:
    branches: [main]
    paths:
      - "frontend/**"
      - ".github/workflows/frontend-deploy.yml"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write # AWS OIDC 인증을 위해 필수
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build
        working-directory: frontend
        # 빌드 시점에 환경별 API 주소 주입이 필요하면 아래와 같이 설정 가능
        # run: npm run build
        # env:
        #   REACT_APP_API_URL: ${{ github.ref_name == 'main' && 'https://api.prod.com' || 'https://api.dev.com' }}
        run: npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # 테라폼 output에서 확인한 Role ARN 사용
          role-to-assume: ${{ github.ref_name == 'main' && secrets.AWS_ROLE_ARN_PROD || secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ap-northeast-2

      - name: Deploy to S3
        run: |
          # 브랜치에 따라 버킷 이름 결정
          ENVIRONMENT=${{ github.ref_name == 'main' && 'prod' || 'dev' }}
          BUCKET_NAME="passit-${ENVIRONMENT}-frontend-bucket"
          
          echo "Deploying to S3 bucket: $BUCKET_NAME"
          # 빌드 결과물 위치(dist 또는 build) 확인 후 수정 필요
          aws s3 sync frontend/dist s3://$BUCKET_NAME --delete

      - name: CloudFront Invalidation
        run: |
          # 테라폼 output의 frontend_cloudfront_id를 Secret에 등록하여 사용 권장
          # 현재는 모든 파일을 무효화하여 즉시 반영
          DIST_ID=${{ github.ref_name == 'main' && secrets.CF_DIST_ID_PROD || secrets.CF_DIST_ID_DEV }}
          if [ -n "$DIST_ID" ]; then
            aws cloudfront create-invalidation --distribution-id $DIST_ID --paths "/*"
          fi