name: Deploy Frontend to Prod

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        type: string
  push:
    branches:
      - main
    paths:
      - "frontend/**"
      - ".github/workflows/deploy-frontend-prod.yml"

env:
  AWS_REGION: ap-northeast-2
  NODE_VERSION: '20'

jobs:
  confirm-deployment:
    name: Confirm Production Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy" ]; then
            echo "❌ Deployment not confirmed. Please type 'deploy' in the confirm field."
            exit 1
          fi
          echo "✅ Production deployment confirmed"

  deploy-frontend:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest
    needs: [confirm-deployment]
    if: always() && (needs.confirm-deployment.result == 'success' || github.event_name == 'push')
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          CI: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform/envs/prod
        run: terraform init

      - name: Get Terraform Outputs
        id: terraform
        working-directory: terraform/envs/prod
        run: |
          BUCKET_NAME=$(terraform output -raw frontend_bucket_name)
          CF_DOMAIN=$(terraform output -raw frontend_cloudfront_domain)
          CF_DIST_ID=$(terraform output -raw frontend_cloudfront_distribution_id)

          echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "cloudfront_domain=$CF_DOMAIN" >> $GITHUB_OUTPUT
          echo "cloudfront_distribution_id=$CF_DIST_ID" >> $GITHUB_OUTPUT

          echo "S3 Bucket: $BUCKET_NAME"
          echo "CloudFront Domain: $CF_DOMAIN"
          echo "CloudFront Distribution ID: $CF_DIST_ID"

      - name: Sync to S3
        working-directory: frontend/build
        run: |
          aws s3 sync . s3://${{ steps.terraform.outputs.bucket_name }} \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "index.html" \
            --exclude "*.map"

          aws s3 cp index.html s3://${{ steps.terraform.outputs.bucket_name }}/index.html \
            --cache-control "public,max-age=0,must-revalidate" \
            --content-type "text/html"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.terraform.outputs.cloudfront_distribution_id }} \
            --paths "/*"

      - name: Deployment summary
        run: |
          echo "### ✅ Frontend Deployment Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket**: ${{ steps.terraform.outputs.bucket_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront URL**: https://${{ steps.terraform.outputs.cloudfront_domain }}" >> $GITHUB_STEP_SUMMARY
          echo "**Git Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Frontend is now live at: https://${{ steps.terraform.outputs.cloudfront_domain }}"
