name: Deploy to DR Environment (Tokyo)

on:
  workflow_dispatch: # 수동 배포만 남겨둠
    inputs:
      service:
        description: "Service to deploy"
        required: false
        type: choice
        options:
          [
            "",
            "account-service",
            "ticket-service",
            "trade-service",
            "cs-service",
            "chat-service",
          ]
      confirm:
        description: 'Type "deploy-dr" to confirm'
        required: true
        type: string

env:
  AWS_REGION: ap-northeast-1 # 도쿄 리전으로 변경
  EKS_CLUSTER_NAME: passit-dr-eks # DR 클러스터명으로 변경

jobs:
  confirm-deployment:
    name: Confirm Production Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy-dr" ]; then
            echo "❌ DR Deployment not confirmed. Please type 'deploy-dr' in the confirm field."
            exit 1
          fi
          echo "✅ DR deployment confirmed"

  update-helm-values:
    runs-on: ubuntu-latest
    needs: [confirm-deployment]
    permissions:
      contents: write   # Helm 값을 수정하고 커밋/푸시하기 위해 필요
      id-token: write    # AWS OIDC 인증을 위해 필수
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DR }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Terraform Init
        working-directory: terraform/envs/dr
        run: terraform init -backend-config="region=ap-northeast-1" # 도쿄 리전에서 실행함을 명시적으로 지정

      - name: Update Helm Values
        working-directory: terraform/scripts
        run: |
          chmod +x update-helm-values.sh
          ./update-helm-values.sh dr

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # 각 서비스의 values-dr.yaml 파일을 명시적으로 추가
          for file in service-account/helm/values-dr.yaml \
                      service-ticket/helm/values-dr.yaml \
                      service-trade/helm/values-dr.yaml \
                      service-cs/helm/values-dr.yaml \
                      service-chat/helm/values-dr.yaml; do
            if [ -f "$file" ]; then
              git add "$file"
            fi
          done
          # 변경사항이 있으면 커밋 및 푸시
          if ! git diff --staged --quiet; then
            git commit -m "chore: update DR Helm values [skip ci]"
            git push
          else
            echo "ℹ️  No changes to commit"
          fi

  trigger-argocd-sync:
    name: Trigger ArgoCD Sync
    runs-on: ubuntu-latest
    needs: update-helm-values
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DR }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.EKS_CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64

      #- name: Port forward ArgoCD Server
      #  run: |
      #    kubectl port-forward svc/argocd-server -n argocd 8080:443 &
      #    sleep 15
      #  continue-on-error: true

      - name: Login to ArgoCD
        run: |
          ARGOCD_SERVER="argocd-dr.passit.cloud"
          ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          argocd login $ARGOCD_SERVER:80 --username admin --password $ARGOCD_PASSWORD --insecure --grpc-web
        continue-on-error: true

      - name: Sync ArgoCD Application
        run: |
          ARGOCD_SERVER="argocd-dr.passit.cloud"
          if [ -z "${{ github.event.inputs.service }}" ]; then
            # Sync all services
            argocd app sync passit-services --server $ARGOCD_SERVER --server-side || true
          else
            # Sync specific service
            SERVICE_NAME="${{ github.event.inputs.service }}-prod"
            argocd app sync $SERVICE_NAME --server $ARGOCD_SERVER --server-side || true
          fi
        continue-on-error: true

      - name: Wait for Sync
        run: |
          ARGOCD_SERVER="argocd-dr.passit.cloud"
          if [ -z "${{ github.event.inputs.service }}" ]; then
            argocd app wait passit-services --server $ARGOCD_SERVER --timeout 300 || true
          else
            SERVICE_NAME="${{ github.event.inputs.service }}-prod"
            argocd app wait $SERVICE_NAME --server $ARGOCD_SERVER --timeout 300 || true
          fi
        continue-on-error: true
