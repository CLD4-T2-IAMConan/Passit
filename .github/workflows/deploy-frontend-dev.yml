name: Deploy Frontend to Dev

on:
  workflow_dispatch:
  push:
    branches:
      - develop
    paths:
      - "frontend/**"
      - ".github/workflows/deploy-frontend-dev.yml"

env:
  AWS_REGION: ap-northeast-2
  NODE_VERSION: "20"

jobs:
  deploy-frontend:
    name: Build and Deploy Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          CI: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform/envs/dev
        run: terraform init

      - name: Get Terraform Outputs
        id: terraform
        working-directory: terraform/envs/dev
        run: |
          BUCKET_NAME=$(terraform output -raw frontend_bucket_name)
          CF_DOMAIN=$(terraform output -raw frontend_cloudfront_domain)
          CF_DIST_ID=$(terraform output -raw frontend_cloudfront_distribution_id)

          echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "cloudfront_domain=$CF_DOMAIN" >> $GITHUB_OUTPUT
          echo "cloudfront_distribution_id=$CF_DIST_ID" >> $GITHUB_OUTPUT

          echo "S3 Bucket: $BUCKET_NAME"
          echo "CloudFront Domain: $CF_DOMAIN"
          echo "CloudFront Distribution ID: $CF_DIST_ID"

      - name: Sync to S3
        working-directory: frontend/build
        run: |
          # 정적 자산 업로드 (캐시 가능)
          aws s3 sync . s3://${{ steps.terraform.outputs.bucket_name }} \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "index.html" \
            --exclude "*.map"

          # index.html 업로드 (캐시 무효화)
          aws s3 cp index.html s3://${{ steps.terraform.outputs.bucket_name }}/index.html \
            --cache-control "public,max-age=0,must-revalidate" \
            --content-type "text/html"

          echo "✅ S3 업로드 완료"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.terraform.outputs.cloudfront_distribution_id }} \
            --paths "/*"

      - name: Deployment summary
        run: |
          echo "### ✅ Frontend Deployment Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: Dev" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket**: ${{ steps.terraform.outputs.bucket_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront URL**: https://${{ steps.terraform.outputs.cloudfront_domain }}" >> $GITHUB_STEP_SUMMARY
          echo "**Git Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Frontend is now live at: https://${{ steps.terraform.outputs.cloudfront_domain }}"
