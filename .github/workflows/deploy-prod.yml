name: Deploy to Prod Environment

on:
  workflow_dispatch:
    inputs:
      service:
        description: "Service to deploy (leave empty for all services)"
        required: false
        type: choice
        options:
          - ""
          - account-service
          - ticket-service
          - trade-service
          - cs-service
          - chat-service
      environment:
        description: "Environment"
        required: true
        type: choice
        options:
          - prod
        default: prod
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        type: string
  push:
    branches:
      - main
    paths:
      - "service-*/**"
      - "terraform/argocd/**"
      - ".github/workflows/deploy-prod.yml"

env:
  AWS_REGION: ap-northeast-2
  EKS_CLUSTER_NAME: passit-prod-eks
  NAMESPACE: services

jobs:
  confirm-deployment:
    name: Confirm Production Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy" ]; then
            echo "❌ Deployment not confirmed. Please type 'deploy' in the confirm field."
            exit 1
          fi
          echo "✅ Production deployment confirmed"

  update-helm-values:
    name: Update Helm Values
    runs-on: ubuntu-latest
    needs: [confirm-deployment]
    if: always() && (needs.confirm-deployment.result == 'success' || github.event_name == 'push')
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.13.5

      - name: Terraform Init
        working-directory: terraform/envs/prod
        run: terraform init

      - name: Update Helm Values
        working-directory: terraform/scripts
        run: |
          chmod +x update-helm-values.sh
          ./update-helm-values.sh prod

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add service-*/helm/values-prod.yaml
          git diff --staged --quiet || git commit -m "chore: update Helm values from Terraform outputs [skip ci]"
          git push

  trigger-argocd-sync:
    name: Trigger ArgoCD Sync
    runs-on: ubuntu-latest
    needs: update-helm-values
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.EKS_CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64

      - name: Port forward ArgoCD Server
        run: |
          kubectl port-forward svc/argocd-server -n argocd 8080:443 &
          sleep 5
        continue-on-error: true

      - name: Login to ArgoCD
        run: |
          ARGOCD_PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          argocd login localhost:8080 --username admin --password $ARGOCD_PASSWORD --insecure --grpc-web
        continue-on-error: true

      - name: Sync ArgoCD Application
        run: |
          if [ -z "${{ github.event.inputs.service }}" ]; then
            # Sync all services
            argocd app sync passit-services --server-side || true
          else
            # Sync specific service
            SERVICE_NAME="${{ github.event.inputs.service }}-prod"
            argocd app sync $SERVICE_NAME --server-side || true
          fi
        continue-on-error: true

      - name: Wait for Sync
        run: |
          if [ -z "${{ github.event.inputs.service }}" ]; then
            argocd app wait passit-services --timeout 300 || true
          else
            SERVICE_NAME="${{ github.event.inputs.service }}-prod"
            argocd app wait $SERVICE_NAME --timeout 300 || true
          fi
        continue-on-error: true
