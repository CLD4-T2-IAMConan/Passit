version: "3.8"

services:
  mysql:
    image: mysql:8.0
    container_name: passit-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_USER: ${MYSQL_USER:-passit_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-passit_password}
    ports:
      - "${MYSQL_PORT:-3307}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init:/docker-entrypoint-initdb.d
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p${MYSQL_ROOT_PASSWORD:-rootpassword}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - passit-network
    command: --default-authentication-plugin=mysql_native_password

  service-trade:
      image: ghcr.io/cld4-t2-iamconan/service-trade:sha-b14ca52
      container_name: passit-service-trade
      platform: linux/amd64
      ports:
        - "${TRADE_PORT:-8083}:8083"
      environment:
        DB_HOST: mysql
        DB_PORT: 3306
        DB_NAME: ${DB_NAME:-passit_db}
        DB_USER: ${MYSQL_USER:-passit_user}
        DB_PASSWORD: ${MYSQL_PASSWORD:-passit_password}
        FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      depends_on:
        mysql:
          condition: service_healthy
      networks:
        - passit-network
      healthcheck:
        test: [ "CMD", "curl", "-f", "http://localhost:8083/api/health" ]
        interval: 30s
        timeout: 10s
        retries: 3
        start_period: 40s

  service-account:
    image: ghcr.io/cld4-t2-iamconan/service-account:sha-ab4a899
    container_name: passit-service-account
    platform: linux/amd64
    ports:
      - "${ACCOUNT_PORT:-8081}:8081"
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-passit_db}
      DB_USER: ${MYSQL_USER:-passit_user}
      DB_PASSWORD: ${MYSQL_PASSWORD:-passit_password}
      MAIL_USERNAME: ${MAIL_USERNAME}
      MAIL_PASSWORD: ${MAIL_PASSWORD}
      KAKAO_REST_API_KEY: ${KAKAO_REST_API_KEY}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET}
      KAKAO_REDIRECT_URI: ${KAKAO_REDIRECT_URI:-http://localhost:8081/api/auth/kakao/callback}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@passit.com}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin123!}
      ADMIN_NAME: ${ADMIN_NAME:-관리자}
      ADMIN_NICKNAME: ${ADMIN_NICKNAME:-admin}
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - passit-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8081/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  service-chat:
    image: ghcr.io/cld4-t2-iamconan/service-chat:sha-cc0fd5b
    container_name: passit-service-chat
    platform: linux/amd64
    ports:
      - "${CHAT_PORT:-8084}:8084"
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-passit_db}
      DB_USER: ${MYSQL_USER:-passit_user}
      DB_PASSWORD: ${MYSQL_PASSWORD:-passit_password}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - passit-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  service-ticket:
    image: ghcr.io/cld4-t2-iamconan/service-ticket:sha-540eb9f
    container_name: passit-service-ticket
    platform: linux/amd64
    ports:
      - "${TICKET_PORT:-8082}:8082"
    environment:
      DB_HOST: mysql
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-passit_db}
      DB_USER: ${MYSQL_USER:-passit_user}
      DB_PASSWORD: ${MYSQL_PASSWORD:-passit_password}

      # 필요한 경우 추가 가능 (예: 이미지 업로드용 S3, JWT 등)
      # S3_BUCKET: ${S3_BUCKET}
      # JWT_SECRET: ${JWT_SECRET}

    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - passit-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8082/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s




volumes:
  mysql_data:
    driver: local

networks:
  passit-network:
    name: passit-network
    driver: bridge
